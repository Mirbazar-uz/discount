name: Deploy Mirbazar

on:
  push:
    branches: [main]

jobs:
  deploy:
    name: Build, Test & Deploy to Production
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            cd /var/www/mirbazar_uz_usr/data/www/mirbazar.uz

            echo "Pulling latest code..."
            git pull origin main

            echo "Stopping containers..."
            docker compose down

            echo "Building containers..."
            docker compose build --no-cache

            echo "Running tests..."
            docker compose run --rm backend pytest tests/ -v --tb=short

            if [ $? -ne 0 ]; then
              echo "Tests failed! Aborting deployment."
              exit 1
            fi

            echo "Starting containers..."
            docker compose up -d

            echo "Waiting for startup..."
            sleep 20

            echo "Health check..."
            curl -f http://127.0.0.1:8000/health || exit 1
            curl -f http://127.0.0.1:3000 || exit 1

            echo "Cleanup old images..."
            docker image prune -f

            echo "Mirbazar deployed successfully!"
