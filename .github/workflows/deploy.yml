name: Deploy Mirbazar

on:
  push:
    branches: [main]

jobs:
  deploy:
    name: Build, Test & Deploy to Production
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: ${{ secrets.SERVER_PORT }}
          command_timeout: 20m
          script: |
            cd /var/www/mirbazar_uz_usr/data/www/mirbazar.uz

            echo "Pulling latest code..."
            git pull origin main

            echo "Stopping containers..."
            docker compose down

            echo "Building containers..."
            docker compose build --no-cache

            echo "Starting containers..."
            docker compose up -d

            echo "Waiting for startup..."
            sleep 30

            echo "Health check..."
            curl -f http://127.0.0.1:8200/health || exit 1
            curl -f http://127.0.0.1:3200 || exit 1

            echo "Cleanup old images..."
            docker image prune -f

            echo "Mirbazar deployed successfully!"
